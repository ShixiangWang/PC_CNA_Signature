---
title: "Survival Analysis"
author: ["Shixiang Wang", "Huimin Li", "Xuan Wang", "Minfang Song", "Xue-Song Liu (Corresponding author)"]
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: kate
    self_contained: false
    mathjax: true
    lightbox: true
    gallery: true
    toc: 3
bibliography: ref.bib
link-citations: yes
---

```{r knitr_init_05, echo=FALSE}
library(knitr)
library(rmdformats)
## Global options
options(max.print = "75")
opts_chunk$set(
  echo = TRUE,
  comment = "#>",
  collapse = TRUE,
  cache = TRUE,
  dpi = 300,
  warning = FALSE,
  message = FALSE,
  tidy = "styler"
)
opts_knit$set(width = 75)
```

To check the clinical relavance of signatures, this part we do survival analysis with Cox model.

## Prepare

Load package **ezcox** for batch Cox analysis.

```{r}
library(ezcox)
```

Load the data.

```{r, eval=FALSE}
df.seqz = readRDS(file = "../output/df.seqz.RDS")
surv_df <- readRDS(file = "../data/PRAD_Survival.rds")
```

Clean the data to generate a data table for survival analysis.


```{r, eval=FALSE}
range01 <- function(x, ...) {
  (x - min(x, ...)) / (max(x, ...) - min(x, ...))
}

cols_to_sigs.seqz <- c(paste0("CN-Sig", 1:5), paste0("SBS-Sig", 1:3))


surv_dt <- dplyr::inner_join(df.seqz %>%
                               dplyr::select(-c("Study", "subject_id", "tumor_body_site",
                                                "tumor_Run", "normal_Run", "CNV_ID",
                                                "Fusion", "sample_type")),
                             surv_df, by = c("PatientID" = "sample"))

dup_ids = which(duplicated(surv_dt$PatientID))
# Remove duplicated records
surv_dt = surv_dt[-dup_ids, ]

# Scale the signature exposure to 0-20.
# To better understand the effect of signature exposure on clinical events,
# here we scale them into range 0-20. 1 increase means 5% increase of signature exposure.
#
# Scale the CNA burden to 0-20.
surv_dt = surv_dt %>%
  dplyr::mutate(cnaBurden = 20 * cnaBurden,
                Stage = as.character(Stage) %>% factor(levels = c("T2", "T3", "T4"))) %>%
  dplyr::mutate_at(cols_to_sigs.seqz, ~ 20 * range01(., na.rm = TRUE))

saveRDS(surv_dt, file = "../output/PRAD_merged_survival_dt_seqz.rds")
```

## OS analysis fo signatures

```{r}
############
surv_dt <- readRDS(file = "../output/PRAD_merged_survival_dt_seqz.rds")
cols_to_sigs.seqz <- c(paste0("CN-Sig", 1:5), paste0("SBS-Sig", 1:3))

# Unvariable analysis
show_forest(surv_dt, covariates = cols_to_sigs.seqz,
            time = "OS.time", status = "OS", merge_models = TRUE)
```


## PFS analysis for signatures


```{r}
show_forest(surv_dt, covariates = cols_to_sigs.seqz,
            time = "PFI.time", status = "PFI", merge_models = TRUE)
```

## OS analysis for features

```{r}
cols_to_features <- c(
  "Age", "Stage", "GleasonScore",
  "n_SNV", "n_driver", "n_INDEL", "Ti_fraction", "Tv_fraction",
  "cnaBurden", "n_CNV", "n_Amp", "n_Del", "ploidy",
  "TD score", "sTD score", "lTD score", "Chromothripisis score",
  "MATH", "n_mutation_cluster", "purity"
)

show_forest(surv_dt,
            covariates = cols_to_features, controls = NULL,
            time = "OS.time", status = "OS", merge_models = TRUE, limits = log(c(0.5, 10)))
```


## PFS analysis for features


```{r}
show_forest(surv_dt,
            covariates = cols_to_features, controls = NULL,
            time = "PFI.time", status = "PFI", merge_models = TRUE, limits = c(log(0.5), log(5)))
```
