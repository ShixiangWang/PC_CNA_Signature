---
title: "Supplementary Analysis and Visualization"
author: ["Shixiang Wang", "Huimin Li", "Xuan Wang", "Minfang Song", "Xue-Song Liu (Corresponding author)"]
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: kate
    self_contained: false
    mathjax: true
    lightbox: true
    gallery: true
bibliography: ref.bib
link-citations: yes
---

```{r knitr_init_99, echo=FALSE}
library(knitr)
library(rmdformats)
## Global options
options(max.print = "75")
opts_chunk$set(
  echo = TRUE,
  comment = "#>",
  collapse = TRUE,
  cache = TRUE,
  dpi = 300,
  warning = FALSE,
  message = FALSE,
  tidy = "styler"
)
opts_knit$set(width = 75)
```

This part shows some supplementary analyses and descriptions.

## FACETS results

We used 2 methods (Sequenza and FACETS) for copy number calling.
However, only Sequenza was used for previous downstream analyses due to
the fact that FACETS generated some unreasonable copy number profile for a few samples.
We will talk about it here.

Let's load the packages and signature data from FACETS and Sequenza.

```{r}
library(sigminer)
library(ggplot2)

load("../output/Sig.CNV.facets.W.RData")
load("../output/Sig.CNV.seqz.W.RData")
load("../output/EST.facets.W.all.RData")
```

According to the estimation of signature number, 6 signatures were extracted.

```{r}
p <- show_sig_number_survey(EST.facets.W.all, right_y = NULL)
add_h_arrow(p, x = 6.1, y = 0.986, seg_len = 0.5)
```

The result signatures are shown as the below.

```{r fig.width=12, fig.height=7}
show_sig_profile(Sig.CNV.facets.W, style = "cosmic", method = "W", normalize = "feature") +
  labs(caption = "Signatures from FACETS")
```

FACETS result has one special and extra signature (**Sig1**) when compared to [Sequenza result](#copy-number-signature-profile).
The **Sig1** shows copy number segments with high percentage of component "copy number value = 0".

> Other signatures are not identical but very similar in most features beteween FACETS and Sequenza results.


We check some samples with **Sig1** enriched.


```{r, message=TRUE}
cn_groups = get_groups(Sig.CNV.facets.W, method = "consensus", match_consensus = TRUE)
cn_expo = get_sig_exposure(Sig.CNV.facets.W, type = "relative")
# Focus on Sig1
df = dplyr::left_join(cn_groups, cn_expo)
load("../output/CNV.facets.RData")
```

```{r, message=TRUE, fig.height=6, fig.width=14}
samps_to_show <- df %>%
  dplyr::filter(enrich_sig == "Sig1") %>%
  dplyr::arrange(dplyr::desc(Sig1)) %>%
  dplyr::slice(1:6) %>%
  dplyr::pull(sample)

samps_to_show

show_cn_profile(
  data = CNV.facets, chrs = paste0("chr", c(1:22, "X")), nrow = 3, ncol = 2, show_title = T,
  samples = samps_to_show
)
```

We can observe that the samples with **Sig1** enriched have many homozygous deletions, this is unreasonable.
I made a communication with the author of FACETS ([issue link](https://github.com/mskcc/facets/issues/147)),

>  So only logical explanation is homozygous deletion. However they are too many of them and so I believe this is assay artifact rather than real.

This problem seems to come from the raw data. However, we checked the data and this signature cannot be found
from the result of Sequenza.

To summary, we used result from Sequenza instead of FACETS for downstream analyses because we found there 
may be some unknown method problems in FACETS (in general, this method is still reliable).

## Method comparison between Macintyre et al and our study

TODO: Show more details described in ["Tally variation records"](#tally-variation-records).

```{r}
load("../output/Sig.CNV.seqz.M.RData")
load("../output/EST.seqz.M.RData")

```

